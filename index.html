<!DOCTYPE html>
<html lang="ne">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aruns E-Services Portal â€” Final</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:"Segoe UI",Arial,sans-serif;background:#f0f4fb;color:#333;min-height:100vh;display:flex;flex-direction:column;}
    /* LOGIN */
    #loginPage{display:flex;justify-content:center;align-items:center;flex:1;background:linear-gradient(120deg,#cfd6dd,#d5e0e9);padding:30px;}
    .login-box{background:#fff;padding:26px;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,0.18);width:340px;text-align:center;}
    .login-box h2{margin-bottom:12px;color:#003366;font-size:20px;}
    .login-box input{width:100%;padding:10px;margin:8px 0;border:1px solid #cfd6e6;border-radius:6px;font-size:15px;}
    .login-box button{width:100%;padding:10px;background:#003366;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:16px;}
    .login-box button:hover{background:#0055aa;}
    .error-msg{color:#b00020;font-size:13px;display:none;margin-top:6px;}

    /* MAIN PAGE */
    #mainPage{display:none;flex-direction:column;min-height:100vh;}
    header{background:linear-gradient(90deg,#001f3f,#004b8d);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:8px 20px;box-shadow:0 2px 10px rgba(0,0,0,0.18);}
    header img.logo{height:55px;border-radius:6px;}
    header .title{text-align:center;flex-grow:1;}
    header .title h1{font-size:20px;margin-bottom:4px;}
    .time-box{
      display:flex;flex-direction:column;align-items:center;padding:6px 12px;border-radius:10px;
      background:linear-gradient(135deg,#003366,#0077cc);
      border:2px solid rgba(0,255,255,0.15);
      box-shadow:0 0 10px rgba(0,255,255,0.12);
      min-width:130px;
      color:#e8f7ff;
      font-size:13px;
    }
    .container{display:grid;grid-template-columns:250px 1fr;flex:1;height:calc(100vh - 160px);background:transparent;}
    .sidebar{background:#e9eff7;border-right:2px solid #c3cbe0;padding:12px;overflow-y:auto;}
    .sidebar h3{color:#003366;margin-bottom:10px;font-size:16px;}
    .folder>div{cursor:pointer;padding:8px 10px;border-radius:6px;display:flex;align-items:center;justify-content:space-between;color:#003366;}
    .folder ul{margin-left:6px;margin-top:8px;list-style:none;display:none;padding-left:6px;}
    .folder.open>ul{display:block;}
    .folder ul li a{text-decoration:none;color:#003366;display:block;padding:6px 8px;border-radius:6px;}
    .folder ul li a:hover{background:#c7d7f0;}
    main{background:#fff;}
    iframe{width:100%;height:100%;border:none;}
    /* single footer inside mainPage */
    footer.main-footer{background:#002b5c;color:#fff;text-align:center;font-size:13px;padding:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .footer-left{display:flex;align-items:center;gap:12px;}
    .footer-actions button{padding:8px 12px;margin-left:8px;background:#004b8d;color:#fff;border:none;border-radius:6px;cursor:pointer;}
    .footer-actions button.restore{background:#0077cc;}
    .footer-actions button:disabled{opacity:0.5;cursor:not-allowed;}

    /* Toast */
    #toast {
      visibility:hidden;
      min-width:220px;
      max-width:360px;
      background:linear-gradient(135deg,#003366,#00aaff);
      color:#fff;
      text-align:center;
      border-radius:8px;
      padding:12px 18px;
      position:fixed;
      top:20px;
      right:20px;
      font-size:14px;
      box-shadow:0 0 12px rgba(0,255,255,0.18);
      opacity:0;
      transform:translateY(-10px);
      transition:opacity 0.35s, transform 0.35s;
      z-index:9999;
    }
    #toast.show {visibility:visible;opacity:1;transform:translateY(0);}
    /* Dashboard card styling (iframe content has its own) */
    @media (max-width:800px){
      .container{grid-template-columns:1fr;}
      .sidebar{height:auto;order:2;}
      main{order:1;height:60vh;}
    }
  </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div class="login-box">
    <h2>ğ‹ğ¨ğ  ğˆğ§ ğŸ”</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <div class="error-msg" id="error">âŒ Invalid Username or Password</div>
    <button id="loginBtn">Login</button>
  </div>
</div>

<!-- MAIN PAGE -->
<div id="mainPage" aria-hidden="true">
  <header>
    <div style="display:flex;align-items:center;gap:12px;">
      <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/5/5b/Bajaj_logo.jpg" alt="Bajaj Logo">
      <div class="time-box" aria-hidden="false">
        <div class="eng" id="engTime">Loading...</div>
        <div class="nep" id="nepTime">à¤¨à¥‡à¤ªà¤¾à¤²à¥€ à¤®à¤¿à¤¤à¤¿...</div>
      </div>
    </div>

    <div class="title">
      <h1>ğŸŒ ğ—ğ—”ğ—•ğ—˜ğ—šğ—¨ğ—›ğ—”ğ—¡ğ—š ğ— ğ—¨ğ—Ÿğ—§ğ—œ ğ—£ğ—¨ğ—¥ğ—£ğ—¢ğ—¦ğ—˜ ğ—–ğ—¢ğ— ğ—£ğ—”ğ—¬ ğ—Ÿğ˜ğ—±.ğŸŒ</h1>
      <p style="font-size:12px;margin-top:4px;opacity:0.9;">ğƒğšğ­ğšğ›ğšğ¬ğ ğ–ğ¢ğ­ğ¡ ğ‚ğ¥ğ¨ğ®ğ ğƒğğ©ğšğ«ğ­ğ¦ğğ§ğ­, ğ†ğ¨ğ¯ğğ«ğ§ğ¦ğğ§ğ­ ğ¨ğŸ ğğğ©ğšğ¥</p>
    </div>
     <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Animated-nepal-flag-image-0007.gif" alt="Nepal Flag">
     <img src="https://upload.wikimedia.org/wikipedia/commons/b/b9/Small_gif.gif" alt="IRD Logo" style="height:60px;">
  </header>

  <div class="container">
    <div class="sidebar">
      <h3>ğğ§ğ¥ğ¢ğ§ğ ğ„-ğ’ğğ«ğ¯ğ¢ğœğğ¬</h3>

      <div class="folder">
        <div onclick="toggleFolder(this)">ğŸ“ ğ‚ğšğ¬ğ¡ ğ‘ğğœğ¨ğ«ğğ¬ <span style="opacity:0.6;font-size:13px;">â–¸</span></div>
        <ul>
          <li><a href="#" onclick="loadEsewaForm();return false;">ğŸ— Cash Transaction </a></li>
          <li><a href="#" onclick="loadEsewaForm();return false;">ğŸ— Statement Report </a></li>
        </ul>
      </div>

      <div class="folder">
        <div onclick="toggleFolder(this)">ğŸ“ ğˆğ§ğªğ®ğ¢ğ«ğ²-ğ…ğ¨ğ¨ğ­ğŸğšğ¥ğ¥ <span style="opacity:0.6;font-size:13px;">â–¸</span></div>
        <ul>
         <li><a href="Online E-Services/Collector/collector-details.html" target="contentFrame">ğŸ— Inquiry Form</a></li>    
         <li><a href="Online E-Services/Collector/collector-download.html" target="contentFrame">ğŸ— Record Download</a></li>
        </ul>
      </div>

      <div class="folder">
        <div onclick="toggleFolder(this)">ğŸ“ ğ•ğğ¡ğ¢ğœğ¥ğ ğğ«ğğğ« ğ‘ğğœğ¨ğ«ğ <span style="opacity:0.6;font-size:13px;">â–¸</span></div>
        <ul>
          <li><a href="Online E-Services/Banks/bank-statement-update.html" target="contentFrame">ğŸ— Order Updates</a></li>   
          <li><a href="Online E-Services/Banks/statement-download.html" target="contentFrame">ğŸ— Order Statement </a></li>
        </ul>
      </div>
    </div>

    <main>
      <iframe name="contentFrame" id="contentFrame" title="Content Frame"></iframe>
    </main>
  </div>

  <footer class="main-footer">
    <div class="footer-left">
      <div>Â© 2025 Database With Cloud Department</div>
      <div style="font-size:12px;opacity:0.85;margin-left:8px;">(Logged in as <strong id="whoami">admin</strong>)</div>
    </div>

    <div class="footer-actions" aria-live="polite">
      <button id="backupBtn" title="Create Backup">ğŸ’¾ Backup</button>
      <button id="restoreBtn" class="restore" title="Restore from Backup">â™»ï¸ Restore</button>
      <button id="logoutBtn" style="background:#b02a2a;margin-left:8px;">ğŸ”’ Logout</button>
    </div>
  </footer>
</div>

<!-- TOAST -->
<div id="toast" role="status" aria-live="polite">Status</div>

<script>
/* ===========================
   Utility & App Constants
   =========================== */
const APP_KEYS = [
  'esewa_entries_v1',
  'collectorData_v_final',
  'bank_statement_html_v2'
];
// Some users might store plain objects/strings; ensure restore handles that safely.

/* ===========================
   Toast helper
   =========================== */
function showToast(msg, ms=3200){
  const t=document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), ms);
}

/* ===========================
   LOGIN / LOGOUT
   =========================== */
document.getElementById('loginBtn').addEventListener('click', ()=>{
  const u=document.getElementById('username').value.trim();
  const p=document.getElementById('password').value.trim();
  const error=document.getElementById('error');
  if(u.toLowerCase()==='admin' && p==='Admin123'){
    document.getElementById('loginPage').style.display='none';
    document.getElementById('mainPage').style.display='flex';
    document.getElementById('mainPage').setAttribute('aria-hidden','false');
    document.getElementById('whoami').textContent = u;
    showToast("âœ… Welcome, Admin!");
    loadDashboard();
  } else {
    error.style.display='block';
    setTimeout(()=>error.style.display='none',3000);
  }
});
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  // simple logout - show login again
  document.getElementById('username').value='';
  document.getElementById('password').value='';
  document.getElementById('mainPage').style.display='none';
  document.getElementById('loginPage').style.display='flex';
  document.getElementById('mainPage').setAttribute('aria-hidden','true');
  document.getElementById('contentFrame').srcdoc = '';
  showToast("ğŸ”’ Logged out");
});

/* ===========================
   Header Clock & Nepali date
   =========================== */
function updateHeaderTime(){
  const now=new Date();
  const eng=now.toLocaleString('en-GB',{weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
  document.getElementById('engTime').textContent=eng;
  document.getElementById('nepTime').textContent=getNepaliDateTime(now);
}
function getNepaliDateTime(date){
  const npMonths=['à¤¬à¥ˆà¤¶à¤¾à¤–','à¤œà¥‡à¤ ','à¤…à¤¸à¤¾à¤°','à¤¸à¤¾à¤‰à¤¨','à¤­à¤¦à¥Œ','à¤…à¤¸à¥‹à¤œ','à¤•à¤¾à¤¤à¥à¤¤à¤¿à¤•','à¤®à¤‚à¤¸à¤¿à¤°','à¤ªà¥à¤·','à¤®à¤¾à¤˜','à¤«à¤¾à¤—à¥à¤¨','à¤šà¥ˆà¤¤'];
  const npNumbers={'0':'à¥¦','1':'à¥§','2':'à¥¨','3':'à¥©','4':'à¥ª','5':'à¥«','6':'à¥¬','7':'à¥­','8':'à¥®','9':'à¥¯'};
  let y=date.getFullYear()+57;
  let m=(date.getMonth()+1+8)%12;if(m===0)m=12;
  let d=date.getDate();
  const npDate=`${npMonths[m-1]} ${d}, ${y}`;
  const h=String(date.getHours()).padStart(2,'0').replace(/[0-9]/g,d=>npNumbers[d]);
  const mi=String(date.getMinutes()).padStart(2,'0').replace(/[0-9]/g,d=>npNumbers[d]);
  const s=String(date.getSeconds()).padStart(2,'0').replace(/[0-9]/g,d=>npNumbers[d]);
  return npDate.replace(/[0-9]/g,d=>npNumbers[d])+" ("+h+":"+mi+":"+s+")";
}
setInterval(updateHeaderTime,1000);
updateHeaderTime();

/* ===========================
   Sidebar toggles & iframe loaders
   =========================== */
function toggleFolder(el){ el.parentElement.classList.toggle('open'); }

function loadEsewaForm(){ 
  const f=document.getElementById('contentFrame');
  f.srcdoc = `
    <html><head><meta charset="utf-8"><title>Esewa Form</title>
    <style>body{font-family:Segoe UI;padding:20px;background:linear-gradient(135deg,#f6fbff,#ffffff);}h3{color:#003366}</style>
    </head><body>
    <h3>Esewa Form Section</h3>
    <p>Existing code placeholder â€” integrate your existing form here.</p>
    </body></html>`;
}
function loadCollectorDetails(){
  const f=document.getElementById('contentFrame');
  f.srcdoc = `<html><head><meta charset="utf-8"><title>Collector Details</title>
    <style>body{font-family:Segoe UI;padding:18px}</style></head><body>
    <h3>Collector Details</h3><p>Collector details placeholder.</p>
    </body></html>`;
}
function loadCollectorDownload(){
  const f=document.getElementById('contentFrame');
  f.srcdoc = `<html><head><meta charset="utf-8"><title>Collector Download</title>
    <style>body{font-family:Segoe UI;padding:18px}</style></head><body>
    <h3>Collector Record Download</h3><p>Download interface placeholder.</p>
    </body></html>`;
}
function loadBankUpdate(){
  const f=document.getElementById('contentFrame');
  f.srcdoc = `<html><head><meta charset="utf-8"><title>Bank Update</title>
    <style>body{font-family:Segoe UI;padding:18px}</style></head><body>
    <h3>Bank Update</h3><p>Bank update placeholder.</p>
    </body></html>`;
}
function loadStatementDownload(){
  const f=document.getElementById('contentFrame');
  f.srcdoc = `<html><head><meta charset="utf-8"><title>Statement Download</title>
    <style>body{font-family:Segoe UI;padding:18px}</style></head><body>
    <h3>Statement Download</h3><p>Statement download placeholder.</p>
    </body></html>`;
}

/* ===========================
   DASHBOARD (loads into iframe)
   =========================== */
function safeParseLocal(key){
  try{
    const raw = localStorage.getItem(key);
    if(raw === null) return [];
    const parsed = JSON.parse(raw);
    // If parsed is array-like, return as array
    if(Array.isArray(parsed)) return parsed;
    // If it's an object with values, convert to array of entries
    if(parsed && typeof parsed === 'object') return Object.values(parsed);
    // fallback - wrap primitive
    return [parsed];
  }catch(e){
    return [];
  }
}
function loadDashboard(){
  const f=document.getElementById('contentFrame');
  const esewa = safeParseLocal('esewa_entries_v1');
  const collector = safeParseLocal('collectorData_v_final');
  const bank = safeParseLocal('bank_statement_html_v2');

  // Build simple dashboard HTML and inject counts
  const doc = `
    <html>
    <head>
      <meta charset="utf-8">
      <title>Dashboard</title>
      <style>body{font-family:Segoe UI;padding:30px;background:linear-gradient(135deg,#dfe9f3,#ffffff);}h2{text-align:center;color:#002b5c;margin-bottom:20px;} .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;} .card{background:linear-gradient(135deg,#004e92,#000428);color:#fff;border-radius:12px;padding:18px;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.15);} .card h3{margin-bottom:10px;font-size:18px;} .num{font-size:28px;font-weight:bold;color:#00e0ff;text-shadow:0 0 10px rgba(0,255,255,0.2);} .muted{font-size:13px;opacity:0.85;margin-top:8px;}</style>
    </head>
    <body>
      <h2>ğŸ“Š Dashboard Summary</h2>
      <div class="cards">
        <div class="card"><h3>Esewa Records</h3><div class="num">${esewa.length}</div><div class="muted">Key: esewa_entries_v1</div></div>
        <div class="card"><h3>Collector Entries</h3><div class="num">${collector.length}</div><div class="muted">Key: collectorData_v_final</div></div>
        <div class="card"><h3>Bank Statements</h3><div class="num">${bank.length}</div><div class="muted">Key: bank_statement_html_v2</div></div>
      </div>
      <script>
        // allow parent to call functions if needed
        window.addEventListener('message', e => {
          if(e.data && e.data.type === 'refreshCounts'){
            location.reload();
          }
        });
      <\/script>
    </body>
    </html>
  `;
  f.srcdoc = doc;
}

/* ===========================
   BACKUP / RESTORE
   =========================== */

// Create a backup JSON containing only APP_KEYS (present or empty)
function backupData(){
  try{
    const backup = {};
    APP_KEYS.forEach(k=>{
      const raw = localStorage.getItem(k);
      // keep as stored (string or null). If null, store empty array
      if(raw === null){
        backup[k] = []; // ensure shape is array for missing keys
      } else {
        try{
          // attempt to parse to store as structured JSON in file
          backup[k] = JSON.parse(raw);
        }catch(e){
          // store raw string if not JSON
          backup[k] = raw;
        }
      }
    });

    const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Backup.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showToast("âœ… Backup created (Backup.json)");
  }catch(err){
    console.error('Backup error', err);
    showToast("âŒ Backup failed");
  }
}

// Restore: open file picker, parse, set localStorage keys (overwrite), then refresh UI
function restoreData(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json,application/JSON';
  input.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try{
        const data = JSON.parse(ev.target.result);
        // Only set keys that are in APP_KEYS to avoid accidental overwrite
        APP_KEYS.forEach(k=>{
          if(typeof data[k] !== 'undefined'){
            // store as stringified JSON so safeParseLocal works
            try{
              localStorage.setItem(k, JSON.stringify(data[k]));
            }catch(setErr){
              // fallback to storing as string
              localStorage.setItem(k, String(data[k]));
            }
          } else {
            // if backup lacked key, ensure key exists as empty array string
            localStorage.setItem(k, JSON.stringify([]));
          }
        });
        showToast("â™»ï¸ Restore completed");
        // Refresh dashboard (iframe) by reloading its srcdoc
        // If dashboard is open, reload; else load dashboard
        loadDashboard();
        // Also send a message to iframe to refresh in case the iframe is same origin (it is srcdoc)
        const f = document.getElementById('contentFrame');
        try{
          f.contentWindow.postMessage({type:'refreshCounts'}, '*');
        }catch(ignore){}
      }catch(err){
        console.error('Restore parse error', err);
        showToast("âŒ Restore failed (invalid file)");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

/* Attach to footer buttons */
document.getElementById('backupBtn').addEventListener('click', backupData);
document.getElementById('restoreBtn').addEventListener('click', restoreData);

/* ===========================
   Init: default dashboard content
   =========================== */
// prefill localStorage with arrays if not present (safe default, optional)
(function ensureDefaults(){
  APP_KEYS.forEach(k=>{
    if(localStorage.getItem(k) === null){
      // leave empty by default to avoid creating unnecessary persisted data unless user wants
      // but for stable UI we can set [] so counts show 0 consistently
      localStorage.setItem(k, JSON.stringify([]));
    }
  });
})();
</script>
</body>
</html>
